@page "/"
@page "/create"
@using System.Text
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>생성</PageTitle>

<MudPaper Class="pa-6">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h5">이미지/PDF로 QuickReport 생성</MudText>
        <MudText Typo="Typo.body2">프롬프트는 DB 누적 내역을 기준으로 API가 참고합니다.</MudText>

        <MudTextField @bind-Value="FormName" Label="폼 이름" Variant="Variant.Outlined" />

        <div>
            <MudText Typo="Typo.subtitle2" Class="mb-1">파일 업로드 (jpg, png, webp, gif, pdf, 최대 5MB)</MudText>
            <InputFile OnChange="OnImageChanged"
                       accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,image/jpeg,image/png,image/gif,image/webp,application/pdf" />
            <MudText Typo="Typo.caption">@SelectedImageLabel</MudText>
        </div>

        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@IsBusy" OnClick="GenerateJsonAsync">JSON 생성</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="@IsBusy" OnClick="DownloadZipAsync">ZIP 다운로드</MudButton>
        </MudStack>

        <MudTextField @bind-Value="LayoutSpecJson"
                      Label="LayoutSpec JSON"
                      Variant="Variant.Outlined"
                      Lines="18"
                      AutoGrow="false" />

        @if (!string.IsNullOrWhiteSpace(Message))
        {
            <MudAlert Severity="Severity.Info">@Message</MudAlert>
        }

        <MudText Typo="Typo.caption">AI 버전: @AiVersion</MudText>
    </MudStack>
</MudPaper>

@code {
    private const long MaxClientReadBytes = 5 * 1024 * 1024;

    private string FormName { get; set; } = "Form_QREmply25";
    private string LayoutSpecJson { get; set; } = "{\n  \"items\": []\n}";
    private string Message { get; set; } = string.Empty;
    private string AiVersion { get; set; } = "불러오는 중...";
    private bool IsBusy { get; set; }
    private IBrowserFile? SelectedImage { get; set; }
    private string SelectedImageLabel { get; set; } = "선택된 파일이 없습니다.";

    private void OnImageChanged(InputFileChangeEventArgs args)
    {
        SelectedImage = args.File;
        SelectedImageLabel = SelectedImage is null
            ? "선택된 파일이 없습니다."
            : $"{SelectedImage.Name} ({SelectedImage.Size} bytes)";
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var version = await Http.GetFromJsonAsync<AiVersionResponse>("api/ai-version");
            AiVersion = string.IsNullOrWhiteSpace(version?.Version) ? "알 수 없음" : version.Version;
        }
        catch
        {
            AiVersion = "확인 불가";
        }
    }

    private async Task GenerateJsonAsync()
    {
        await ExecuteAsync(async () =>
        {
            using var content = await BuildMultipartContentAsync();
            var docId = Uri.EscapeDataString(FormName.Trim());
            var response = await Http.PostAsync($"api/documents/{docId}/generate", content);
            var body = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode)
            {
                Message = MapErrorMessage(body, "JSON 생성 실패");
                return;
            }

            LayoutSpecJson = PrettyJson(body);
            Message = "JSON 생성 완료";
        });
    }

    private async Task DownloadZipAsync()
    {
        await ExecuteAsync(async () =>
        {
            using var content = await BuildMultipartContentAsync();
            var response = await Http.PostAsync("api/export-from-image", content);

            if (!response.IsSuccessStatusCode)
            {
                var body = await response.Content.ReadAsStringAsync();
                Message = $"ZIP 다운로드 실패: {body}";
                return;
            }

            var bytes = await response.Content.ReadAsByteArrayAsync();
            await JS.InvokeVoidAsync("downloadFileFromBytes", $"{FormName}.zip", "application/zip", bytes);
            Message = "ZIP 다운로드를 시작했습니다.";
        });
    }

    private async Task ExecuteAsync(Func<Task> action)
    {
        if (IsBusy)
        {
            return;
        }

        try
        {
            IsBusy = true;
            Message = string.Empty;
            await action();
        }
        catch (Exception ex)
        {
            Message = $"오류: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task<MultipartFormDataContent> BuildMultipartContentAsync()
    {
        if (string.IsNullOrWhiteSpace(FormName))
        {
            throw new InvalidOperationException("폼 이름이 필요합니다.");
        }

        if (SelectedImage is null)
        {
            throw new InvalidOperationException("이미지 또는 PDF를 업로드하세요.");
        }

        await using var stream = SelectedImage.OpenReadStream(MaxClientReadBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var imageBytes = ms.ToArray();

        var content = new MultipartFormDataContent();
        content.Add(new StringContent(FormName.Trim(), Encoding.UTF8), "formName");

        var imageContent = new ByteArrayContent(imageBytes);
        if (!string.IsNullOrWhiteSpace(SelectedImage.ContentType))
        {
            imageContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(SelectedImage.ContentType);
        }

        content.Add(imageContent, "image", SelectedImage.Name);
        return content;
    }

    private static string PrettyJson(string json)
    {
        using var doc = JsonDocument.Parse(json);
        return JsonSerializer.Serialize(doc.RootElement, new JsonSerializerOptions { WriteIndented = true });
    }

    private static string MapErrorMessage(string body, string fallbackPrefix)
    {
        try
        {
            using var doc = JsonDocument.Parse(body);
            var root = doc.RootElement;

            if (root.TryGetProperty("details", out var detailsElement) &&
                detailsElement.ValueKind == JsonValueKind.Array)
            {
                foreach (var item in detailsElement.EnumerateArray())
                {
                    var text = item.GetString() ?? string.Empty;
                    if (text.Contains("ClaudeStatus=529", StringComparison.OrdinalIgnoreCase) ||
                        text.Contains("Overloaded", StringComparison.OrdinalIgnoreCase))
                    {
                        return "서버 과부하 클로드 문제입니다.";
                    }
                }
            }
        }
        catch
        {
        }

        return $"{fallbackPrefix}: {body}";
    }

    private sealed class AiVersionResponse
    {
        public string? Version { get; set; }
        public string? Model { get; set; }
    }
}

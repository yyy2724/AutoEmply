@page "/presets"
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime Js

<PageTitle>프롬프트 관리</PageTitle>

<MudPaper Class="pa-5 mb-3" Elevation="1" Outlined="true">
    <MudStack Spacing="1">
        <MudText Typo="Typo.h5">프롬프트 프리셋 관리</MudText>
        <MudText Typo="Typo.body2" Class="mud-secondary-text">
            프리셋을 조회하고, 수정/삭제하거나 새 프리셋을 등록할 수 있습니다.
        </MudText>
        <MudText Typo="Typo.caption" Class="mud-secondary-text">
            전체 @PresetItems.Count 개 · 활성 @ActivePresetCount 개 · 비활성 @InactivePresetCount 개
        </MudText>
    </MudStack>
</MudPaper>

<MudGrid Spacing="3">
    <MudItem xs="12" md="5">
        <MudPaper Class="pa-4" Outlined="true">
            <MudStack Spacing="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">프리셋 목록</MudText>
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="LoadPresetsAsync" Disabled="@IsBusy">새로고침</MudButton>
                </MudStack>

                <MudTable Items="PresetItems" Dense="true" Hover="true" Bordered="true" Striped="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>이름</MudTh>
                        <MudTh>상태</MudTh>
                        <MudTh>수정일시</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="이름">@context.Name</MudTd>
                        <MudTd DataLabel="상태">@(context.IsActive ? "활성" : "비활성")</MudTd>
                        <MudTd DataLabel="수정일시">@context.UpdatedAt.LocalDateTime.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="@(() => SelectPreset(context))">편집</MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2">등록된 프리셋이 없습니다.</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="7">
        <MudPaper Class="pa-4" Outlined="true">
            <MudStack Spacing="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">@((EditingId.HasValue ? "프리셋 수정" : "새 프리셋 등록"))</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="NewPreset" Disabled="@IsBusy">새로 작성</MudButton>
                </MudStack>

                <MudDivider />
                <MudTextField @bind-Value="Form.Name" Label="프리셋 이름" Variant="Variant.Outlined" Required="true" />
                <MudTextField @bind-Value="Form.SystemPrompt" Label="시스템 프롬프트" Variant="Variant.Outlined" Lines="10" Required="true" />
                <MudTextField @bind-Value="Form.UserPromptTemplate" Label="사용자 프롬프트 템플릿" Variant="Variant.Outlined" Lines="3" Required="true" />
                <MudTextField @bind-Value="Form.StyleRulesJson" Label="스타일 규칙 JSON (선택)" Variant="Variant.Outlined" Lines="3" />

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="Form.Model" Label="모델명 (선택)" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField T="decimal?" @bind-Value="Form.Temperature" Label="온도(Temperature)" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField T="int?" @bind-Value="Form.MaxTokens" Label="최대 토큰 수" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <MudCheckBox @bind-Value="Form.IsActive" Label="활성 프리셋으로 사용" />

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync" Disabled="@IsBusy">저장</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="DeleteAsync" Disabled="@(!EditingId.HasValue || IsBusy)">삭제</MudButton>
                </MudStack>

                @if (!string.IsNullOrWhiteSpace(Message))
                {
                    <MudAlert Severity="Severity.Info" Dense="true">@Message</MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool IsBusy { get; set; }
    private string Message { get; set; } = string.Empty;
    private List<PromptPresetDto> PresetItems { get; set; } = new();
    private Guid? EditingId { get; set; }
    private PresetForm Form { get; set; } = PresetForm.CreateDefault();
    private int ActivePresetCount => PresetItems.Count(x => x.IsActive);
    private int InactivePresetCount => PresetItems.Count - ActivePresetCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadPresetsAsync();
    }

    private async Task LoadPresetsAsync()
    {
        try
        {
            IsBusy = true;
            Message = string.Empty;
            PresetItems = await Http.GetFromJsonAsync<List<PromptPresetDto>>("api/prompts") ?? new();
        }
        catch (Exception ex)
        {
            Message = $"목록 조회 실패: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void NewPreset()
    {
        EditingId = null;
        Form = PresetForm.CreateDefault();
        Message = string.Empty;
    }

    private void SelectPreset(PromptPresetDto preset)
    {
        EditingId = preset.Id;
        Form = new PresetForm
        {
            Name = preset.Name,
            SystemPrompt = preset.SystemPrompt,
            UserPromptTemplate = preset.UserPromptTemplate,
            StyleRulesJson = preset.StyleRulesJson,
            Model = preset.Model,
            Temperature = preset.Temperature,
            MaxTokens = preset.MaxTokens ?? 8192,
            IsActive = preset.IsActive
        };
        Message = string.Empty;
    }

    private async Task SaveAsync()
    {
        if (string.IsNullOrWhiteSpace(Form.Name) ||
            string.IsNullOrWhiteSpace(Form.SystemPrompt) ||
            string.IsNullOrWhiteSpace(Form.UserPromptTemplate))
        {
            Message = "프리셋 이름, 시스템 프롬프트, 사용자 프롬프트 템플릿은 필수입니다.";
            return;
        }

        try
        {
            IsBusy = true;
            Message = string.Empty;

            var createRequest = new CreatePromptPresetRequest
            {
                Name = Form.Name.Trim(),
                SystemPrompt = Form.SystemPrompt.Trim(),
                UserPromptTemplate = Form.UserPromptTemplate.Trim(),
                StyleRulesJson = NormalizeNullable(Form.StyleRulesJson),
                Model = NormalizeNullable(Form.Model),
                Temperature = Form.Temperature,
                MaxTokens = Form.MaxTokens,
                IsActive = Form.IsActive
            };

            HttpResponseMessage response;
            if (EditingId.HasValue)
            {
                response = await Http.PutAsJsonAsync(
                    $"api/prompts/{EditingId.Value}",
                    new UpdatePromptPresetRequest
                    {
                        Name = createRequest.Name,
                        SystemPrompt = createRequest.SystemPrompt,
                        UserPromptTemplate = createRequest.UserPromptTemplate,
                        StyleRulesJson = createRequest.StyleRulesJson,
                        Model = createRequest.Model,
                        Temperature = createRequest.Temperature,
                        MaxTokens = createRequest.MaxTokens,
                        IsActive = createRequest.IsActive
                    });
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/prompts", createRequest);
            }

            var body = await response.Content.ReadAsStringAsync();
            if (!response.IsSuccessStatusCode)
            {
                Message = $"저장 실패: {body}";
                return;
            }

            Message = "저장되었습니다.";
            var wasEditing = EditingId;
            await LoadPresetsAsync();
            if (wasEditing.HasValue)
            {
                var updated = PresetItems.FirstOrDefault(x => x.Id == wasEditing.Value);
                if (updated is not null)
                {
                    SelectPreset(updated);
                }
            }
            else
            {
                NewPreset();
            }
        }
        catch (Exception ex)
        {
            Message = $"저장 실패: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task DeleteAsync()
    {
        if (!EditingId.HasValue)
        {
            return;
        }

        var ok = await Js.InvokeAsync<bool>("confirm", $"'{Form.Name}' 프리셋을 삭제할까요?");
        if (!ok)
        {
            return;
        }

        try
        {
            IsBusy = true;
            Message = string.Empty;

            var response = await Http.DeleteAsync($"api/prompts/{EditingId.Value}");
            if (!response.IsSuccessStatusCode)
            {
                var body = await response.Content.ReadAsStringAsync();
                Message = $"삭제 실패: {body}";
                return;
            }

            Message = "삭제되었습니다.";
            await LoadPresetsAsync();
            NewPreset();
        }
        catch (Exception ex)
        {
            Message = $"삭제 실패: {ex.Message}";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private static string? NormalizeNullable(string? value) =>
        string.IsNullOrWhiteSpace(value) ? null : value.Trim();

    private sealed class PromptPresetDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string SystemPrompt { get; set; } = string.Empty;
        public string UserPromptTemplate { get; set; } = string.Empty;
        public string? StyleRulesJson { get; set; }
        public string? Model { get; set; }
        public decimal? Temperature { get; set; }
        public int? MaxTokens { get; set; }
        public bool IsActive { get; set; }
        public DateTimeOffset CreatedAt { get; set; }
        public DateTimeOffset UpdatedAt { get; set; }
    }

    private sealed class CreatePromptPresetRequest
    {
        public string Name { get; set; } = string.Empty;
        public string SystemPrompt { get; set; } = string.Empty;
        public string UserPromptTemplate { get; set; } = string.Empty;
        public string? StyleRulesJson { get; set; }
        public string? Model { get; set; }
        public decimal? Temperature { get; set; }
        public int? MaxTokens { get; set; }
        public bool IsActive { get; set; }
    }

    private sealed class UpdatePromptPresetRequest
    {
        public string Name { get; set; } = string.Empty;
        public string SystemPrompt { get; set; } = string.Empty;
        public string UserPromptTemplate { get; set; } = string.Empty;
        public string? StyleRulesJson { get; set; }
        public string? Model { get; set; }
        public decimal? Temperature { get; set; }
        public int? MaxTokens { get; set; }
        public bool IsActive { get; set; }
    }

    private sealed class PresetForm
    {
        public string Name { get; set; } = string.Empty;
        public string SystemPrompt { get; set; } = string.Empty;
        public string UserPromptTemplate { get; set; } = string.Empty;
        public string? StyleRulesJson { get; set; }
        public string? Model { get; set; }
        public decimal? Temperature { get; set; } = 0;
        public int? MaxTokens { get; set; } = 8192;
        public bool IsActive { get; set; } = true;

        public static PresetForm CreateDefault() =>
            new()
            {
                Name = $"Prompt-{DateTime.UtcNow:yyyyMMddHHmmss}",
                SystemPrompt =
                    "You generate Delphi QuickReport LayoutSpec JSON. Return only one valid JSON object with top-level {\"items\":[...]}. " +
                    "No markdown, no explanation, no extra keys. items must contain at least one item. Empty array is never allowed.",
                UserPromptTemplate = "formName={{formName}}. Return valid LayoutSpec JSON only.",
                MaxTokens = 8192,
                Temperature = 0,
                IsActive = true
            };
    }
}
